<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>è®¾å¤‡æ£€æµ‹å·¥å…· Â· å®Œæ•´ç‰ˆï¼ˆæ³¨å†Œ/ç™»å½•/PBKDF2/è¯­è¨€/æµ‹é€Ÿ/å¤šè´¦å·ï¼‰</title>
<style>
:root{
  --bg:#070708;--card:#0f1112;--muted:#9aa0a6;--accent:#00e6c2;--accent2:#00a3ff;--danger:#ff6b6b;--radius:12px;
}
html,body{height:100%;margin:0;background:var(--bg);color:#fff;font-family: "Segoe UI", Roboto, "Helvetica Neue", Arial;}
body.windows { --accent:#4cd1ff; --accent2:#1e90ff; }
body.android { --accent:#00e676; --accent2:#64dd17; }
body.ios     { --accent:#ffb86b; --accent2:#ff7a59; }
header{display:flex;justify-content:space-between;align-items:center;padding:14px 18px;border-bottom:1px solid rgba(255,255,255,0.03);}
.logo{display:flex;align-items:center;gap:12px}
.logo .box{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-weight:700;color:#041616}
h1{font-size:16px;margin:0;color:var(--accent)}
.muted{color:var(--muted)}
.container{max-width:1100px;margin:22px auto;padding:0 16px;}
.grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px;}
.card{background:linear-gradient(180deg,var(--card), rgba(255,255,255,0.02));padding:14px;border-radius:var(--radius);box-shadow:0 8px 30px rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.03);transform:translateY(18px);opacity:0;transition:all .5s ease;}
.card.visible{transform:none;opacity:1;}
.col-4{grid-column:span 4;}
.col-5{grid-column:span 5;}
.col-3{grid-column:span 3;}
.col-12{grid-column:span 12;}
@media(max-width:900px){.col-4,.col-5,.col-3{grid-column:span 12}}
input,select,textarea{background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);padding:10px;border-radius:8px;color:#fff;width:100%;box-sizing:border-box}
label{font-size:13px;color:var(--muted)}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.btn{background:var(--accent);color:#031213;padding:8px 12px;border-radius:10px;border:none;cursor:pointer;font-weight:700}
.btn.secondary{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--accent)}
.btn.danger{background:var(--danger);color:#fff}
.small{font-size:13px}
.tiny{font-size:12px;color:var(--muted)}
.table{width:100%;border-collapse:collapse}
.table th,.table td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.03);text-align:left;font-size:13px}
.table th{color:var(--accent)}
.footer{padding:18px;text-align:center;color:var(--muted)}
.badge{display:inline-block;padding:6px 8px;background:rgba(0,0,0,0.2);border-radius:999px;font-weight:700}
.search{display:flex;gap:8px;align-items:center}
#settingsModal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:999}
.modal-card{width:100%;max-width:720px;background:linear-gradient(180deg,var(--card), rgba(255,255,255,0.02));padding:16px;border-radius:12px}
.note{font-size:13px;color:var(--muted)}
/* small helpers */
.flex-between{display:flex;justify-content:space-between;align-items:center}
.form-row{display:flex;gap:8px}
.form-row > *{flex:1}
</style>
</head>
<body>
<header>
  <div class="logo">
    <div class="box">DT</div>
    <div>
      <h1>è®¾å¤‡æ£€æµ‹å·¥å…· Â· å®Œæ•´ç‰ˆ</h1>
      <div class="tiny muted">æœ¬åœ°æ¼”ç¤º Â· æ”¯æŒæ³¨å†Œ/ç™»å½•/PBKDF2/å¤šè´¦å·/æµ‹é€Ÿ</div>
    </div>
  </div>
  <div class="row">
    <div id="net-status" class="badge tiny">ç¦»çº¿</div>
    <div id="ui-device" class="badge tiny">è®¾å¤‡</div>
  </div>
</header>

<div class="container">
  <!-- LOGIN & REGISTER -->
  <div id="auth-area" class="card col-12" style="display:block;">
    <div class="flex-between">
      <div>
        <div style="font-weight:700;font-size:16px">ğŸ” ç™»å½• / æ³¨å†Œ</div>
        <div class="tiny muted">æ³¨å†Œä¼šåœ¨æœ¬åœ°åŠ å¯†ä¿å­˜ç”¨æˆ·ï¼ˆPBKDF2 + éšæœº saltï¼‰ã€‚ç¤ºä¾‹åç«¯åŒæ­¥ä¹Ÿå¯é€‰ã€‚</div>
      </div>
      <div class="tiny muted">é»˜è®¤ admin / 12345678</div>
    </div>
    <div style="height:12px"></div>
    <div style="display:flex;gap:16px;flex-wrap:wrap">
      <div style="flex:1;min-width:280px">
        <label>ç”¨æˆ·å</label>
        <input id="auth-username" value="admin" />
      </div>
      <div style="flex:1;min-width:240px">
        <label>å¯†ç </label>
        <input id="auth-password" type="password" value="12345678" />
      </div>
      <div style="min-width:140px;display:flex;flex-direction:column;gap:8px">
        <label>æ“ä½œ</label>
        <div class="row">
          <button class="btn" onclick="login()">ç™»å½•</button>
          <button class="btn secondary" onclick="showRegister()">æ³¨å†Œ</button>
          <button class="btn secondary" onclick="showReset()">é‡ç½®å¯†ç </button>
        </div>
      </div>
    </div>
    <div id="auth-msg" class="note" style="margin-top:10px;color:var(--danger);display:none"></div>
    <div style="height:12px"></div>
    <div class="tiny muted">è¯´æ˜ï¼šå‰ç«¯åŠ å¯†ä»…ä½œæ¼”ç¤ºç”¨é€”ã€‚ç”Ÿäº§ç¯å¢ƒè¯·ä½¿ç”¨åç«¯éªŒè¯ä¸å®‰å…¨å­˜å‚¨ã€‚</div>
  </div>

  <!-- REGISTER FORM -->
  <div id="register-area" class="card col-12" style="display:none;">
    <div style="font-weight:700">ğŸ“ æ³¨å†Œæ–°è´¦æˆ·</div>
    <div style="height:8px"></div>
    <div class="form-row">
      <div><label>ç”¨æˆ·å</label><input id="reg-username" /></div>
      <div><label>å¯†ç </label><input id="reg-password" type="password" /></div>
      <div style="min-width:120px"><label>é‡å¤å¯†ç </label><input id="reg-password2" type="password" /></div>
    </div>
    <div style="height:8px"></div>
    <div class="row" style="gap:8px">
      <button class="btn" onclick="register()">æ³¨å†Œ</button>
      <button class="btn secondary" onclick="hideRegister()">å–æ¶ˆ</button>
    </div>
    <div id="reg-msg" class="note" style="margin-top:8px;display:none"></div>
  </div>

  <!-- PASSWORD RESET -->
  <div id="reset-area" class="card col-12" style="display:none">
    <div style="font-weight:700">ğŸ”§ é‡ç½®å¯†ç ï¼ˆæ¼”ç¤ºï¼‰</div>
    <div style="height:8px"></div>
    <div class="form-row">
      <div><label>ç”¨æˆ·å</label><input id="rst-username" /></div>
      <div><label>æ–°å¯†ç </label><input id="rst-password" type="password" /></div>
      <div style="min-width:120px"><label>é‡å¤</label><input id="rst-password2" type="password" /></div>
    </div>
    <div style="height:8px"></div>
    <div class="row">
      <button class="btn" onclick="resetPassword()">ä¿å­˜é‡ç½®</button>
      <button class="btn secondary" onclick="hideReset()">å–æ¶ˆ</button>
    </div>
    <div id="rst-msg" class="note" style="display:none"></div>
  </div>

  <!-- APP (hidden until logged in) -->
  <div id="app" style="display:none">
    <div class="grid" style="margin-top:10px;">
      <div class="card col-4" id="card-user">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div class="muted">å½“å‰ç”¨æˆ·</div>
            <div style="font-weight:700;font-size:18px" id="cur-user">-</div>
            <div class="tiny muted" id="cur-role">è§’è‰²: æ™®é€šç”¨æˆ·</div>
          </div>
          <div style="text-align:right">
            <div class="tiny muted">ç•Œé¢é£æ ¼</div>
            <div class="badge tiny" id="ui-style">é»˜è®¤</div>
            <div style="height:8px"></div>
            <div class="row">
              <button class="btn secondary" onclick="openSettings()">è®¾ç½®</button>
              <button class="btn danger" onclick="logout()">é€€å‡º</button>
            </div>
          </div>
        </div>
      </div>

      <div class="card col-5" id="card-time">
        <div class="muted">â³ å½“å‰æ—¶é—´</div>
        <div style="margin-top:10px">
          <div id="local-time" style="font-weight:700;font-size:18px">--:--:--</div>
          <div class="tiny muted" id="utc-time">UTC: --:--:--</div>
          <div class="tiny muted" id="date-day">æ—¥æœŸ: ----</div>
        </div>
      </div>

      <div class="card col-3" id="card-net">
        <div class="muted">ğŸŒ ç½‘ç»œ</div>
        <div id="net-block" style="margin-top:10px">
          <div id="net-ip" class="small muted">IP: -</div>
          <div id="net-isp" class="tiny muted">ISP: -</div>
          <div style="height:8px"></div>
          <div class="row">
            <button class="btn" onclick="runPingTest()">Ping</button>
            <button class="btn secondary" onclick="runSpeedTest()">æµ‹é€Ÿ</button>
          </div>
          <div id="speed-result" class="tiny muted" style="margin-top:8px">é€Ÿåº¦: -</div>
        </div>
      </div>
    </div>

    <div class="grid" style="margin-top:12px">
      <div class="card col-4">
        <div class="muted">ğŸ’» ç³»ç»Ÿä¿¡æ¯</div>
        <table class="table" style="margin-top:8px"><tbody id="sys-table"><tr><th>é¡¹ç›®</th><th>å€¼</th></tr></tbody></table>
      </div>

      <div class="card col-5">
        <div class="muted">ğŸ–¥ ç¡¬ä»¶ä¿¡æ¯</div>
        <table class="table" style="margin-top:8px"><tbody id="hw-table"><tr><th>é¡¹ç›®</th><th>å€¼</th></tr></tbody></table>
      </div>

      <div class="card col-3">
        <div class="muted">ğŸ—£ è¯­è¨€ç³»ç»Ÿ</div>
        <div id="lang-default" class="small" style="margin-top:8px"></div>
        <div id="lang-supported" class="tiny muted" style="margin-top:6px"></div>
        <div style="height:8px"></div>
        <div class="muted">å…¨çƒè¯­è¨€ï¼ˆæœç´¢ï¼‰</div>
        <div style="height:6px"></div>
        <div class="search">
          <input id="lang-search" placeholder="æœç´¢è¯­è¨€ä»£ç /ä¸­æ–‡/è‹±æ–‡" oninput="renderLangTable()" />
          <button class="btn secondary" onclick="document.getElementById('lang-search').value='';renderLangTable()">æ¸…é™¤</button>
        </div>
        <div style="height:8px"></div>
        <div style="max-height:260px;overflow:auto;">
          <table class="table"><thead><tr><th>ä»£ç </th><th>ä¸­æ–‡</th><th>è‹±æ–‡</th></tr></thead><tbody id="lang-table"></tbody></table>
        </div>
      </div>
    </div>

    <!-- Admin: user management -->
    <div id="admin-area" style="display:none;margin-top:12px;">
      <div class="card col-12">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><div style="font-weight:700">ğŸ›  å¤šè´¦å·ç®¡ç†ï¼ˆç®¡ç†å‘˜ä¸“ç”¨ï¼‰</div><div class="tiny muted">å¯æ–°å¢/åˆ é™¤/ä¿®æ”¹ç”¨æˆ·ï¼ˆä»…æœ¬åœ°å­˜å‚¨ï¼‰</div></div>
          <div>
            <div class="row" style="gap:8px">
              <input id="new-username" placeholder="ç”¨æˆ·å" style="width:140px" />
              <input id="new-password" placeholder="å¯†ç " type="password" style="width:160px" />
              <select id="new-role"><option value="user">æ™®é€šç”¨æˆ·</option><option value="admin">ç®¡ç†å‘˜</option></select>
              <button class="btn" onclick="adminAddUser()">æ–°å¢</button>
            </div>
          </div>
        </div>
        <div style="height:8px"></div>
        <div style="max-height:220px;overflow:auto;">
          <table class="table"><thead><tr><th>ç”¨æˆ·å</th><th>è§’è‰²</th><th>æ“ä½œ</th></tr></thead><tbody id="user-table"></tbody></table>
        </div>
      </div>
    </div>

    <div style="height:12px"></div>
    <div class="footer">
      &copy; <span id="copyright-year"></span> è®¾å¤‡æ£€æµ‹å·¥å…· Â· æ¼”ç¤ºç‰ˆ Â· è¯·å‹¿å°†æ­¤é¡µé¢ä½œä¸ºå”¯ä¸€çš„å®‰å…¨æªæ–½
    </div>
  </div>
</div>

<!-- Settings modal -->
<div id="settingsModal">
  <div class="modal-card">
    <div class="flex-between">
      <div style="font-weight:700;color:var(--accent)">è®¾ç½®</div>
      <div>
        <button class="btn secondary" onclick="closeSettings()">å…³é—­</button>
      </div>
    </div>
    <div style="height:10px"></div>
    <div>
      <div class="note">æ›´æ”¹å¯†ç ï¼ˆå½“å‰ç™»å½•ç”¨æˆ·ï¼‰</div>
      <div style="height:8px"></div>
      <div class="form-row"><input id="setpass-old" type="password" placeholder="æ—§å¯†ç " /><input id="setpass-new" type="password" placeholder="æ–°å¯†ç " /></div>
      <div style="height:8px"></div>
      <div class="row"><button class="btn" onclick="changeMyPassword()">ä¿å­˜</button><button class="btn secondary" onclick="closeSettings()">å–æ¶ˆ</button></div>
      <div style="height:12px"></div>
      <div class="note">å¯å°†ç”¨æˆ·æ•°æ®åŒæ­¥åˆ°åç«¯ï¼ˆç¤ºä¾‹ï¼‰</div>
      <div style="height:8px"></div>
      <div class="row"><input id="backend-url" placeholder="åç«¯æ¥å£ URL (ç¤ºä¾‹: https://example.com/api/usersync)" /><button class="btn" onclick="syncToBackend()">åŒæ­¥</button></div>
      <div id="sync-msg" class="note" style="margin-top:8px;display:none"></div>
    </div>
  </div>
</div>

<script>
/* ==========================
   æ•°æ®/å­˜å‚¨ç»“æ„è¯´æ˜ï¼ˆlocalStorageï¼‰
   - dt_users_v2 => { username: {hash:..., salt:..., iterations:..., role:'admin'/'user'} , ... }
   - dt_login_v2 => { username, ts, remember }
   ========================== */

const LS_USERS = 'dt_users_v2';
const LS_LOGIN = 'dt_login_v2';

/* ----------------- PBKDF2 helpers ----------------- */
async function pbkdf2Hex(password, saltHex, iterations=120000, keylen=32){
  const enc = new TextEncoder();
  const passKey = enc.encode(password);
  const salt = hexToUint8(saltHex);
  const baseKey = await crypto.subtle.importKey('raw', passKey, {name:'PBKDF2'}, false, ['deriveBits']);
  const derived = await crypto.subtle.deriveBits({name:'PBKDF2', salt, iterations, hash:'SHA-256'}, baseKey, keylen*8);
  const arr = Array.from(new Uint8Array(derived));
  return arr.map(b=>b.toString(16).padStart(2,'0')).join('');
}
function genSaltHex(len=16){
  const arr = new Uint8Array(len);
  crypto.getRandomValues(arr);
  return Array.from(arr).map(b=>b.toString(16).padStart(2,'0')).join('');
}
function hexToUint8(hex){
  if(!hex) return new Uint8Array();
  const res = new Uint8Array(hex.length/2);
  for(let i=0;i<res.length;i++) res[i]=parseInt(hex.substr(i*2,2),16);
  return res;
}

/* ----------------- user store ----------------- */
function loadUsers(){
  try{ return JSON.parse(localStorage.getItem(LS_USERS) || '{}'); }catch(e){ return {}; }
}
function saveUsers(obj){ localStorage.setItem(LS_USERS, JSON.stringify(obj)); }
async function ensureDefault(){
  const users = loadUsers();
  if(!users['admin']){
    const salt = genSaltHex();
    const iter = 120000;
    const hash = await pbkdf2Hex('12345678', salt, iter);
    users['admin'] = {hash, salt, iterations: iter, role:'admin'};
    saveUsers(users);
    console.log('åˆ›å»ºé»˜è®¤ç”¨æˆ· admin');
  }
}

/* ----------------- UI helpers ----------------- */
function showEl(id){ document.getElementById(id).style.display = 'block'; }
function hideEl(id){ document.getElementById(id).style.display = 'none'; }
function setMsg(id, txt, err=false){ const el=document.getElementById(id); el.style.display='block'; el.style.color = err? 'var(--danger)': 'var(--accent)'; el.textContent = txt; setTimeout(()=>el.style.display='none',4000); }

/* ----------------- Auth actions ----------------- */
async function register(){
  const u = (document.getElementById('reg-username').value || '').trim();
  const p = document.getElementById('reg-password').value || '';
  const p2 = document.getElementById('reg-password2').value || '';
  if(!u || !p){ setMsg('reg-msg','è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ', true); return; }
  if(p !== p2){ setMsg('reg-msg','ä¸¤æ¬¡å¯†ç ä¸ä¸€è‡´', true); return; }
  const users = loadUsers();
  if(users[u]){ setMsg('reg-msg','ç”¨æˆ·å·²å­˜åœ¨', true); return; }
  const salt = genSaltHex(); const iter = 120000;
  const hash = await pbkdf2Hex(p, salt, iter);
  users[u] = {hash, salt, iterations: iter, role:'user'};
  saveUsers(users);
  setMsg('reg-msg','æ³¨å†ŒæˆåŠŸï¼Œè¯·ç™»å½•');
  document.getElementById('reg-username').value=''; document.getElementById('reg-password').value=''; document.getElementById('reg-password2').value='';
  hideRegister();
}
function showRegister(){ hideEl('auth-area'); showEl('register-area'); }
function hideRegister(){ showEl('auth-area'); hideEl('register-area'); }

async function login(){
  const u = (document.getElementById('auth-username').value || '').trim();
  const p = document.getElementById('auth-password').value || '';
  if(!u || !p){ setMsg('auth-msg','è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ', true); return; }
  const users = loadUsers();
  if(!users[u]){ setMsg('auth-msg','ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯', true); return; }
  const record = users[u];
  const h = await pbkdf2Hex(p, record.salt, record.iterations);
  if(h === record.hash){
    // ç™»å½•æˆåŠŸ
    localStorage.setItem(LS_LOGIN, JSON.stringify({username:u,ts:Date.now(), remember: true}));
    initApp();
  } else setMsg('auth-msg','ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯', true);
}

function logout(){
  localStorage.removeItem(LS_LOGIN);
  location.reload();
}

/* ----------------- Reset password (simple flow) ----------------- */
function showReset(){ hideEl('auth-area'); showEl('reset-area'); }
function hideReset(){ showEl('auth-area'); hideEl('reset-area'); }

async function resetPassword(){
  const u = (document.getElementById('rst-username').value || '').trim();
  const p = document.getElementById('rst-password').value || '';
  const p2 = document.getElementById('rst-password2').value || '';
  if(!u || !p){ setMsg('rst-msg','è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ', true); return; }
  if(p !== p2){ setMsg('rst-msg','ä¸¤æ¬¡å¯†ç ä¸ä¸€è‡´', true); return; }
  const users = loadUsers();
  if(!users[u]){ setMsg('rst-msg','ç”¨æˆ·ä¸å­˜åœ¨', true); return; }
  const salt = genSaltHex(); const iter = 120000;
  const hash = await pbkdf2Hex(p, salt, iter);
  users[u] = {...users[u], hash, salt, iterations: iter};
  saveUsers(users);
  setMsg('rst-msg','å¯†ç å·²é‡ç½®');
  hideReset();
}

/* ----------------- Admin functions ----------------- */
async function adminAddUser(){
  const u = (document.getElementById('new-username').value || '').trim();
  const p = document.getElementById('new-password').value || '';
  const role = document.getElementById('new-role').value;
  if(!u || !p){ alert('è¯·è¾“å…¥ç”¨æˆ·åä¸å¯†ç '); return; }
  const users = loadUsers();
  if(users[u]){ alert('ç”¨æˆ·å·²å­˜åœ¨'); return; }
  const salt = genSaltHex(); const iter = 120000;
  const hash = await pbkdf2Hex(p, salt, iter);
  users[u] = {hash, salt, iterations: iter, role};
  saveUsers(users);
  document.getElementById('new-username').value=''; document.getElementById('new-password').value='';
  renderUserTable();
}
function adminDelUser(u){ if(!confirm('åˆ é™¤ç”¨æˆ· '+u+' ?')) return; const users=loadUsers(); delete users[u]; saveUsers(users); renderUserTable(); }
function adminToggleAdmin(u){
  const users=loadUsers(); if(!users[u]) return;
  users[u].role = users[u].role === 'admin' ? 'user' : 'admin'; saveUsers(users); renderUserTable();
}
function renderUserTable(){
  const tbody = document.getElementById('user-table'); tbody.innerHTML='';
  const users = loadUsers();
  Object.keys(users).forEach(u=>{
    const tr = document.createElement('tr');
    const role = users[u].role || 'user';
    tr.innerHTML = `<td class="small">${u}</td><td class="small">${role}</td>
      <td class="small">
        <button class="btn secondary" onclick="adminToggleAdmin('${u}')">${role==='admin'?'é™ä¸ºç”¨æˆ·':'è®¾ä¸ºç®¡ç†å‘˜'}</button>
        <button class="btn danger" onclick="adminDelUser('${u}')">åˆ é™¤</button>
      </td>`;
    tbody.appendChild(tr);
  });
}

/* ----------------- Device detection & UI apply ----------------- */
function detectDevice(){
  const ua = navigator.userAgent || navigator.vendor || window.opera || '';
  const lower = ua.toLowerCase();
  if(/windows phone|windows/i.test(lower)) return 'Windows';
  if(/android/i.test(lower)) return 'Android';
  if(/iphone|ipad|ipod|ios/i.test(lower) || (navigator.platform && /iPad|iPhone|iPod/.test(navigator.platform))) return 'iOS';
  if(/macintosh|mac os x/i.test(lower)) return 'Mac';
  if(/linux/i.test(lower)) return 'Linux';
  return 'Other';
}
function applyDeviceUI(device){
  document.getElementById('ui-device').textContent = device;
  const b = document.body; b.classList.remove('windows','android','ios');
  if(device==='Windows') b.classList.add('windows');
  if(device==='Android') b.classList.add('android');
  if(device==='iOS') b.classList.add('ios');
  document.getElementById('ui-style').textContent = device;
}

/* ----------------- System / Hardware populate ----------------- */
function parseOSVersion(){
  const ua = navigator.userAgent;
  let os='Unknown', ver='';
  if(/Windows NT 10/i.test(ua)) { os='Windows'; ver='10/11'; }
  else if(/Android\s+([\d_.]+)/i.test(ua)) { os='Android'; ver=(ua.match(/Android\s+([\d_.]+)/i)||[])[1]; }
  else if(/iPhone OS\s([\d_]+)/i.test(ua)) { os='iOS'; ver=(ua.match(/iPhone OS\s([\d_]+)/i)||[])[1].replace(/_/g,'.'); }
  else if(/Mac OS X\s([\d_]+)/i.test(ua)){ os='macOS'; ver=(ua.match(/Mac OS X\s([\d_]+)/i)||[])[1].replace(/_/g,'.'); }
  else if(/Linux/i.test(ua)) { os='Linux'; ver='-'; }
  return {os,ver};
}
function parseBrowser(){
  const ua = navigator.userAgent;
  let name='Unknown', ver='-', engine='Unknown';
  if(/Edg\/([\d.]+)/.test(ua)){ name='Edge'; ver=(ua.match(/Edg\/([\d.]+)/)||[])[1]; engine='Blink'; }
  else if(/OPR\/([\d.]+)/.test(ua)){ name='Opera'; ver=(ua.match(/OPR\/([\d.]+)/)||[])[1]; engine='Blink'; }
  else if(/Chrome\/([\d.]+)/.test(ua) && !/Chromium/.test(ua)){ name='Chrome'; ver=(ua.match(/Chrome\/([\d.]+)/)||[])[1]; engine='Blink'; }
  else if(/Safari\/([\d.]+)/.test(ua) && /Version\/([\d.]+)/.test(ua)){ name='Safari'; ver=(ua.match(/Version\/([\d.]+)/)||[])[1]; engine='WebKit'; }
  else if(/Firefox\/([\d.]+)/.test(ua)){ name='Firefox'; ver=(ua.match(/Firefox\/([\d.]+)/)||[])[1]; engine='Gecko'; }
  else if(/Chromium\/([\d.]+)/.test(ua)){ name='Chromium'; ver=(ua.match(/Chromium\/([\d.]+)/)||[])[1]; engine='Blink'; }
  return {name,ver,engine};
}
function populateSystem(){
  const st = document.getElementById('sys-table'); st.innerHTML = '<tr><th>é¡¹ç›®</th><th>å€¼</th></tr>';
  const p = parseOSVersion(), b = parseBrowser();
  const rows = [
    ['æ“ä½œç³»ç»Ÿ', p.os + (p.ver ? ' ' + p.ver : '')],
    ['å¹³å° (navigator.platform)', navigator.platform || '-'],
    ['æµè§ˆå™¨', `${b.name} ${b.ver}`],
    ['æ¸²æŸ“å†…æ ¸', b.engine],
    ['UserAgent', navigator.userAgent],
    ['è¯­è¨€', navigator.language || '-'],
    ['æ”¯æŒè¯­è¨€', (navigator.languages||[]).join(', ') || '-'],
    ['æ—¶åŒº', Intl.DateTimeFormat().resolvedOptions().timeZone || '-'],
  ];
  rows.forEach(r=>{
    const tr=document.createElement('tr'); tr.innerHTML = `<td class="tiny muted">${r[0]}</td><td class="small">${r[1]}</td>`; st.appendChild(tr);
  });
}
function populateHardware(){
  const t = document.getElementById('hw-table'); t.innerHTML='<tr><th>é¡¹ç›®</th><th>å€¼</th></tr>';
  const rows = [
    ['å±å¹•åˆ†è¾¨ç‡', `${window.screen.width} Ã— ${window.screen.height}`],
    ['å¯ç”¨å±å¹•', `${window.screen.availWidth} Ã— ${window.screen.availHeight}`],
    ['è®¾å¤‡åƒç´ æ¯” (DPR)', window.devicePixelRatio || '-'],
    ['CPU æ ¸å¿ƒæ•°', navigator.hardwareConcurrency || 'æœªçŸ¥'],
    ['å†…å­˜ (GB)', navigator.deviceMemory ? navigator.deviceMemory + ' GB' : 'æœªçŸ¥'],
    ['è§¦æ§æ”¯æŒ', ('ontouchstart' in window) ? 'æ˜¯' : 'å¦'],
    ['ç½‘ç»œåœ¨çº¿', navigator.onLine ? 'åœ¨çº¿' : 'ç¦»çº¿']
  ];
  rows.forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td class="tiny muted">${r[0]}</td><td class="small">${r[1]}</td>`; t.appendChild(tr); });
}

/* ----------------- Time ----------------- */
let timeInterval = null;
function startClock(){
  function tick(){
    const now=new Date();
    document.getElementById('local-time').textContent = now.toLocaleTimeString();
    document.getElementById('utc-time').textContent = 'UTC: ' + now.toUTCString().split(' ')[4];
    document.getElementById('date-day').textContent = 'æ—¥æœŸ: ' + now.toISOString().split('T')[0] + ' Â· ' + now.toLocaleDateString('zh-CN',{weekday:'long'});
    document.getElementById('copyright-year').textContent = new Date().getFullYear();
  }
  tick(); if(timeInterval) clearInterval(timeInterval); timeInterval=setInterval(tick,1000);
}

/* ----------------- Language list (å¤§é‡å†…ç½®ï¼Œå¯æ‰©å±•) ----------------- */
/* ä¸ºç®€æ´ï¼Œåˆ—è¡¨å®šä¹‰ä¸ºæ•°ç»„ï¼ˆå¯è¿›ä¸€æ­¥æ‰©å……åˆ° 200+ï¼‰ */
const GLOBAL_LANGS = [
  ['zh-CN','ç®€ä½“ä¸­æ–‡','Simplified Chinese'],
  ['zh-TW','ç¹é«”ä¸­æ–‡','Traditional Chinese'],
  ['en-US','è‹±è¯­ï¼ˆç¾å›½ï¼‰','English (United States)'],
  ['en-GB','è‹±è¯­ï¼ˆè‹±å›½ï¼‰','English (United Kingdom)'],
  ['es-ES','è¥¿ç­ç‰™è¯­ï¼ˆè¥¿ç­ç‰™ï¼‰','Spanish (Spain)'],
  ['es-MX','è¥¿ç­ç‰™è¯­ï¼ˆå¢¨è¥¿å“¥ï¼‰','Spanish (Mexico)'],
  ['pt-BR','è‘¡è„ç‰™è¯­ï¼ˆå·´è¥¿ï¼‰','Portuguese (Brazil)'],
  ['pt-PT','è‘¡è„ç‰™è¯­ï¼ˆè‘¡è„ç‰™ï¼‰','Portuguese (Portugal)'],
  ['fr-FR','æ³•è¯­ï¼ˆæ³•å›½ï¼‰','French (France)'],
  ['de-DE','å¾·è¯­ï¼ˆå¾·å›½ï¼‰','German (Germany)'],
  ['it-IT','æ„å¤§åˆ©è¯­','Italian'],
  ['ja-JP','æ—¥è¯­','Japanese'],
  ['ko-KR','éŸ©è¯­','Korean'],
  ['ru-RU','ä¿„è¯­','Russian'],
  ['ar-SA','é˜¿æ‹‰ä¼¯è¯­','Arabic'],
  ['hi-IN','å°åœ°è¯­','Hindi'],
  ['bn-BD','å­ŸåŠ æ‹‰è¯­','Bengali'],
  ['pa-IN','æ—é®æ™®è¯­','Punjabi'],
  ['vi-VN','è¶Šå—è¯­','Vietnamese'],
  ['id-ID','å°å°¼è¯­','Indonesian'],
  ['ms-MY','é©¬æ¥è¯­','Malay'],
  ['th-TH','æ³°è¯­','Thai'],
  ['tr-TR','åœŸè€³å…¶è¯­','Turkish'],
  ['nl-NL','è·å…°è¯­','Dutch'],
  ['sv-SE','ç‘å…¸è¯­','Swedish'],
  ['pl-PL','æ³¢å…°è¯­','Polish'],
  ['ro-RO','ç½—é©¬å°¼äºšè¯­','Romanian'],
  ['el-GR','å¸Œè…Šè¯­','Greek'],
  ['he-IL','å¸Œä¼¯æ¥è¯­','Hebrew'],
  ['hu-HU','åŒˆç‰™åˆ©è¯­','Hungarian'],
  ['cs-CZ','æ·å…‹è¯­','Czech'],
  ['sk-SK','æ–¯æ´›ä¼å…‹è¯­','Slovak'],
  ['bg-BG','ä¿åŠ åˆ©äºšè¯­','Bulgarian'],
  ['uk-UA','ä¹Œå…‹å…°è¯­','Ukrainian'],
  ['sr-RS','å¡å°”ç»´äºšè¯­','Serbian'],
  ['hr-HR','å…‹ç½—åœ°äºšè¯­','Croatian'],
  ['lt-LT','ç«‹é™¶å®›è¯­','Lithuanian'],
  ['lv-LV','æ‹‰è„±ç»´äºšè¯­','Latvian'],
  ['et-EE','çˆ±æ²™å°¼äºšè¯­','Estonian'],
  ['sl-SI','æ–¯æ´›æ–‡å°¼äºšè¯­','Slovenian'],
  ['fa-IR','æ³¢æ–¯è¯­','Persian'],
  ['ur-PK','ä¹Œå°”éƒ½è¯­','Urdu'],
  ['sw-KE','æ–¯ç“¦è¥¿é‡Œè¯­','Swahili'],
  ['af-ZA','å—éè·å…°è¯­','Afrikaans'],
  ['zu-ZA','ç¥–é²è¯­','Zulu'],
  ['xh-ZA','ç§‘è¨è¯­','Xhosa'],
  ['am-ET','é˜¿å§†å“ˆæ‹‰è¯­','Amharic'],
  ['ne-NP','å°¼æ³Šå°”è¯­','Nepali'],
  ['si-LK','åƒ§ä¼½ç½—è¯­','Sinhala'],
  ['mk-MK','é©¬å…¶é¡¿è¯­','Macedonian'],
  ['sq-AL','é˜¿å°”å·´å°¼äºšè¯­','Albanian'],
  ['bn-IN','å­ŸåŠ æ‹‰è¯­ï¼ˆå°åº¦ï¼‰','Bengali (India)'],
  ['mr-IN','é©¬æ‹‰åœ°è¯­','Marathi'],
  ['te-IN','æ³°å¢å›ºè¯­','Telugu'],
  ['ta-IN','æ³°ç±³å°”è¯­','Tamil'],
  ['kn-IN','å¡çº³è¾¾è¯­','Kannada'],
  ['ml-IN','é©¬æ‹‰é›…æ‹‰å§†è¯­','Malayalam'],
  ['gu-IN','å¤å‰æ‹‰ç‰¹è¯­','Gujarati'],
  ['or-IN','å¥¥é‡Œäºšè¯­','Odia'],
  ['as-IN','é˜¿è¨å§†è¯­','Assamese'],
  ['ha-NG','è±ªè¨è¯­','Hausa'],
  ['yo-NG','çº¦é²å·´è¯­','Yoruba'],
  ['ig-NG','ä¼Šåšè¯­','Igbo'],
  ['so-SO','ç´¢é©¬é‡Œè¯­','Somali'],
  ['mn-MN','è’™å¤è¯­','Mongolian'],
  ['kk-KZ','å“ˆè¨å…‹è¯­','Kazakh'],
  ['uz-UZ','ä¹Œå…¹åˆ«å…‹è¯­','Uzbek'],
  ['az-AZ','é˜¿å¡æ‹œç–†è¯­','Azerbaijani'],
  ['hy-AM','äºšç¾å°¼äºšè¯­','Armenian'],
  ['ka-GE','æ ¼é²å‰äºšè¯­','Georgian'],
  ['mn-CN','è’™å¤è¯­ï¼ˆä¸­æ–‡ï¼‰','Mongolian (China)'],
  ['bo-CN','è—è¯­','Tibetan'],
  ['ne-IN','å°¼æ³Šå°”è¯­ï¼ˆå°åº¦ï¼‰','Nepali (India)'],
  ['tl-PH','ä»–åŠ ç¦„è¯­','Tagalog'],
  ['ceb-PH','å®¿åŠ¡è¯­','Cebuano'],
  ['ilo-PH','ä¼Šæ´›å¡è¯ºè¯­','Ilocano'],
  ['hmn-CN','è‹—è¯­','Hmong'],
  ['my-MM','ç¼…ç”¸è¯­','Burmese'],
  ['km-KH','é«˜æ£‰è¯­','Khmer'],
  ['lo-LA','è€æŒè¯­','Lao'],
  ['ps-AF','æ™®ä»€å›¾è¯­','Pashto'],
  ['sd-PK','ä¿¡å¾·è¯­','Sindhi'],
  ['gl-ES','åŠ åˆ©è¥¿äºšè¯­','Galician'],
  ['eu-ES','å·´æ–¯å…‹è¯­','Basque'],
  ['cy-GB','å¨å°”å£«è¯­','Welsh'],
  ['ga-IE','çˆ±å°”å…°è¯­','Irish'],
  ['lb-LU','å¢æ£®å ¡è¯­','Luxembourgish'],
  ['mt-MT','é©¬è€³ä»–è¯­','Maltese'],
  ['is-IS','å†°å²›è¯­','Icelandic'],
  ['sq-MK','é˜¿å°”å·´å°¼äºšè¯­ï¼ˆé©¬å…¶é¡¿ï¼‰','Albanian (Macedonia)']
];
// render languages
function renderLangTable(){
  const q = (document.getElementById('lang-search').value || '').trim().toLowerCase();
  const tbody = document.getElementById('lang-table'); tbody.innerHTML='';
  GLOBAL_LANGS.forEach(it=>{
    const code=it[0], cn=it[1], en=it[2];
    const hay = (code+' '+cn+' '+en).toLowerCase();
    if(q && hay.indexOf(q)===-1) return;
    const tr=document.createElement('tr');
    tr.innerHTML = `<td class="small">${code}</td><td class="small">${cn}</td><td class="small">${en}</td>`;
    tbody.appendChild(tr);
  });
}

/* ----------------- Network info (ipapi) ----------------- */
async function fetchIP(){
  try{
    const res = await fetch('https://ipapi.co/json/');
    if(!res.ok) throw new Error('net err');
    const data = await res.json();
    document.getElementById('net-ip').textContent = 'IP: ' + (data.ip || '-');
    document.getElementById('net-isp').textContent = (data.org || '-') + ' Â· ' + (data.city || '-') + ' Â· ' + (data.country_name || '-');
  }catch(e){
    document.getElementById('net-ip').textContent = 'IP: æ— æ³•è·å–ï¼ˆCORS/æœ¬åœ°æ–‡ä»¶é™åˆ¶ï¼‰';
    document.getElementById('net-isp').textContent = '';
    console.warn('fetchIP failed', e);
  }
}

/* ----------------- Ping & Speed Test -----------------
   - Ping: use fetch to small resource and measure RTT (may be affected by CORS)
   - Speed: attempt to download a known public file; if CORS blocks, fallback to generated data simulation.
   Note: In real site,åº”è¯¥ä½¿ç”¨ä¸“é—¨çš„æµ‹é€ŸåŸŸåä¸æœåŠ¡å™¨æ”¯æŒ CORSã€‚
-------------------------------------------------- */
async function runPingTest(){
  const t0 = performance.now();
  const url = 'https://www.google.com/images/branding/googlelogo/2x/googlelogo_color_92x30dp.png'; // small file (may be blocked)
  try{
    await fetch(url, {mode:'no-cors'}); // attempt, no-cors avoids CORS error but gives opaque response â€” timing still possible
    const t1 = performance.now();
    setSpeedText(`Ping ~ ${Math.round(t1-t0)} ms (ä¼°ç®—)`);
  }catch(e){
    // fallback: XHR to same origin (will fail if local file) â€” show message
    setSpeedText('Ping æµ‹è¯•å¤±è´¥ï¼ˆCORS æˆ– æœ¬åœ°æ–‡ä»¶ ï¼‰');
    console.warn('ping fail', e);
  }
}

function setSpeedText(txt){ document.getElementById('speed-result').textContent = 'æµ‹é€Ÿ: ' + txt; }

/* basic download speed test (best-effort, may be blocked) */
async function runSpeedTest(){
  setSpeedText('å¼€å§‹ä¸‹è½½æµ‹è¯•...');
  // Try to download a moderately sized resource with CORS; if fails, fallback to simulated test
  const testFiles = [
    'https://speed.hetzner.de/100MB.bin',
    'https://speed.hetzner.de/10MB.bin',
    'https://cdn.cloudflare.steamstatic.com/steam/apps/2568280/header.jpg' // random
  ];
  let success=false;
  for(const url of testFiles){
    try{
      const t0 = performance.now();
      const r = await fetch(url, {mode:'cors'}); // may fail CORS
      if(!r.ok) throw new Error('non-200');
      const blob = await r.blob();
      const t1 = performance.now();
      const size = blob.size; // bytes
      const seconds = (t1 - t0)/1000;
      const mbps = (size*8/seconds)/(1024*1024);
      setSpeedText(`${mbps.toFixed(2)} Mbps Â· ${Math.round(size/1024)} KB downloaded in ${seconds.toFixed(2)} s`);
      success = true; break;
    }catch(e){
      console.warn('speed test attempt failed', e);
    }
  }
  if(!success){
    // fallback simulated test (generate random data and "download" in-memory)
    const t0 = performance.now();
    // generate 5 MB blob locally to simulate speed (this measures local generation speed â€” not real network)
    const size = 5*1024*1024;
    const arr = new Uint8Array(size);
    crypto.getRandomValues(arr);
    const t1 = performance.now();
    const seconds = Math.max((t1-t0)/1000, 0.001);
    setSpeedText(`æ— æ³•å®ŒæˆçœŸå®ä¸‹è½½æµ‹è¯•ï¼Œå·²ç”¨æœ¬åœ°æ¨¡æ‹Ÿæµ‹é‡ï¼ˆä»…ä¾›å‚è€ƒï¼‰: ç”Ÿæˆ ${Math.round(size/1024)} KB ç”¨æ—¶ ${seconds.toFixed(3)} s`);
  }
}

/* ----------------- Backend sync example ----------------- */
async function syncToBackend(){
  const url = document.getElementById('backend-url').value.trim();
  if(!url){ setMsg('sync-msg','è¯·è¾“å…¥åç«¯ URL', true); return; }
  const users = loadUsers();
  try{
    const res = await fetch(url, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({users})});
    if(!res.ok) throw new Error('ç½‘ç»œé”™è¯¯');
    setMsg('sync-msg','å·²åŒæ­¥åˆ°åç«¯');
  }catch(e){
    setMsg('sync-msg','åŒæ­¥å¤±è´¥ï¼ˆç¤ºä¾‹ï¼šè¯·æ”¹ä¸ºçœŸå®å¯ç”¨æ¥å£ï¼‰', true);
    console.warn('sync fail', e);
  }
}

/* ----------------- Change my password ----------------- */
async function changeMyPassword(){
  const oldp = document.getElementById('setpass-old').value || '';
  const newp = document.getElementById('setpass-new').value || '';
  if(!oldp || !newp){ alert('è¯·è¾“å…¥æ—§å¯†ç ä¸æ–°å¯†ç '); return; }
  const st = localStorage.getItem(LS_LOGIN); if(!st){ alert('æœªç™»å½•'); return; }
  const cur = JSON.parse(st).username;
  const users = loadUsers(); if(!users[cur]) { alert('ç”¨æˆ·ä¸å­˜åœ¨'); return; }
  const rec = users[cur];
  const oldHash = await pbkdf2Hex(oldp, rec.salt, rec.iterations);
  if(oldHash !== rec.hash){ alert('æ—§å¯†ç ä¸æ­£ç¡®'); return; }
  const salt = genSaltHex(), iter=120000; const newHash = await pbkdf2Hex(newp, salt, iter);
  users[cur] = {...rec, hash:newHash, salt, iterations: iter};
  saveUsers(users);
  alert('å¯†ç å·²æ›´æ–°ï¼ˆå·²ä¿å­˜æœ¬åœ°å“ˆå¸Œï¼‰');
  document.getElementById('setpass-old').value=''; document.getElementById('setpass-new').value='';
  closeSettings();
}

/* ----------------- Settings modal ----------------- */
function openSettings(){ document.getElementById('settingsModal').style.display='flex'; }
function closeSettings(){ document.getElementById('settingsModal').style.display='none'; }

/* ----------------- initApp (after login) ----------------- */
function revealCards(){
  document.querySelectorAll('.card').forEach((c,i)=>setTimeout(()=>c.classList.add('visible'), i*60));
}
async function initApp(){
  const st = localStorage.getItem(LS_LOGIN);
  if(!st){ /* show auth area */ document.getElementById('auth-area').style.display='block'; return; }
  const login = JSON.parse(st);
  const users = loadUsers();
  if(!users[login.username]){ // invalid stored login
    localStorage.removeItem(LS_LOGIN); location.reload(); return;
  }
  // hide auth, show app
  document.getElementById('auth-area').style.display='none';
  document.getElementById('register-area').style.display='none';
  document.getElementById('reset-area').style.display='none';
  document.getElementById('app').style.display='block';
  document.getElementById('cur-user').textContent = login.username;
  document.getElementById('cur-role').textContent = 'è§’è‰²: ' + (users[login.username].role || 'user');
  if(users[login.username].role === 'admin') document.getElementById('admin-area').style.display='block'; else document.getElementById('admin-area').style.display='none';
  renderUserTable();
  applyDeviceUI(detectDevice());
  populateSystem(); populateHardware(); startClock(); renderLangTable(); fetchIP();
  revealCards();
}

/* ----------------- Auto init on load ----------------- */
(async function(){
  await ensureDefault();
  // auto login if previously remembered
  const st = localStorage.getItem(LS_LOGIN);
  if(st){
    try{ const obj = JSON.parse(st); if(obj && obj.remember){ initApp(); return; } }catch(e){}
  }
  // else show auth UI
  renderLangTable();
  document.getElementById('auth-area').style.display='block';
  // set online status
  document.getElementById('net-status').textContent = navigator.onLine ? 'åœ¨çº¿' : 'ç¦»çº¿';
  document.getElementById('ui-device').textContent = detectDevice();
})();

/* ----------------- small helpers for accessibility ----------------- */
window.login = login; window.register = register; window.showRegister = showRegister; window.hideRegister = hideRegister;
window.showReset = showReset; window.hideReset = hideReset; window.resetPassword = resetPassword;
window.openSettings = openSettings; window.closeSettings = closeSettings; window.changeMyPassword = changeMyPassword;
window.adminAddUser = adminAddUser; window.adminDelUser = adminDelUser; window.adminToggleAdmin = adminToggleAdmin;
window.runPingTest = runPingTest; window.runSpeedTest = runSpeedTest; window.syncToBackend = syncToBackend;

/* expose logout */
window.logout = logout;
</script>
</body>
        </html>
